{"version":3,"sources":["../src/weightedPoolMath.ts"],"sourcesContent":["/// Reference \"Out-Given-In\" section in Balancer whitepaper https://balancer.fi/whitepaper.pdf\n/// ********************************************************************************************\n/// calcOutGivenIn                                                                            //\n/// aO = tokenAmountOut                                                                       //\n/// bO = tokenBalanceOut                                                                      //\n/// bI = tokenBalanceIn              /      /            bI             \\    (wI / wO) \\      //\n/// aI = tokenAmountIn    aO = bO * |  1 - | --------------------------  | ^            |     //\n/// wI = tokenWeightIn               \\      \\ ( bI + ( aI * ( 1 - sF )) /              /      //\n/// wO = tokenWeightOut                                                                       //\n/// sF = swapFee                                                                              //\n/// ********************************************************************************************\nexport function calcOutGivenInWeighted(\n  bI: number,\n  wI: number,\n  bO: number,\n  wO: number,\n  aI: number,\n  sF: number,\n): number {\n  const denom = bI + aI * (1 - sF);\n  return bO * (1 - Math.pow(bI / denom, wI / wO));\n}\n\n/// Reference \"In-Given-Out\" section in Balancer whitepaper https://balancer.fi/whitepaper.pdf\n/// ********************************************************************************************\n/// calcInGivenOut                                                                            //\n/// aI = tokenAmountIn                                                                        //\n/// bO = tokenBalanceOut               /  /     bO      \\    (wO / wI)      \\                 //\n/// bI = tokenBalanceIn          bI * |  | ------------  | ^            - 1  |                //\n/// aO = tokenAmountOut    aI =        \\  \\ ( bO - aO ) /                   /                 //\n/// wI = tokenWeightIn           --------------------------------------------                 //\n/// wO = tokenWeightOut                          ( 1 - sF )                                   //\n/// sF = swapFee                                                                              //\n/// ********************************************************************************************\nexport function calcInGivenOutWeighted(\n  bI: number,\n  wI: number,\n  bO: number,\n  wO: number,\n  aO: number,\n  sF: number,\n): number {\n  return (bI * (Math.pow(bO / (bO - aO), wO / wI) - 1)) / (1 - sF);\n}\n\nexport function calcPriceImpactPercentageWeighted(\n  exactAmountIn: number,\n  exactAmountOut: number,\n  balanceIn: number,\n  balanceOut: number,\n  weightIn: number,\n  weightOut: number,\n): number {\n  if (balanceOut - exactAmountOut < 0.000001) {\n    // to avoid loss of accuracy, we just return 100%\n    return 100;\n  }\n\n  // https://docs.balancer.fi/v/v1/core-concepts/protocol/index#spot-price\n  // price1To0 = (balance0 / balance1) * (weight1 / weight0)\n  const oldPrice = ((balanceIn / balanceOut) * weightOut) / weightIn;\n\n  // update new balance\n  balanceIn = balanceIn + exactAmountIn;\n  balanceOut = balanceOut - exactAmountOut;\n  const newPrice = ((balanceIn / balanceOut) * weightOut) / weightIn;\n\n  return (Math.abs(newPrice - oldPrice) / oldPrice) * 100;\n}\n"],"mappings":";AAWO,SAAS,uBACd,IACA,IACA,IACA,IACA,IACA,IACQ;AACR,QAAM,QAAQ,KAAK,MAAM,IAAI;AAC7B,SAAO,MAAM,IAAI,KAAK,IAAI,KAAK,OAAO,KAAK,EAAE;AAC/C;AAaO,SAAS,uBACd,IACA,IACA,IACA,IACA,IACA,IACQ;AACR,SAAQ,MAAM,KAAK,IAAI,MAAM,KAAK,KAAK,KAAK,EAAE,IAAI,MAAO,IAAI;AAC/D;AAEO,SAAS,kCACd,eACA,gBACA,WACA,YACA,UACA,WACQ;AACR,MAAI,aAAa,iBAAiB,MAAU;AAE1C,WAAO;AAAA,EACT;AAIA,QAAM,WAAa,YAAY,aAAc,YAAa;AAG1D,cAAY,YAAY;AACxB,eAAa,aAAa;AAC1B,QAAM,WAAa,YAAY,aAAc,YAAa;AAE1D,SAAQ,KAAK,IAAI,WAAW,QAAQ,IAAI,WAAY;AACtD;","names":[]}